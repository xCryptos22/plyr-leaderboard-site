<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>SpeedInk √ó PLYR Leaderboard</title>
  <meta name="theme-color" content="#0B0B0D"/>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
        extend: {
          colors: {
            bg: { 900:'#0B0B0D', 800:'#111114', 700:'#16161A' },
            border: { 900:'rgba(255,255,255,0.08)' },
            textc: { 50:'#FFFFFF', 200:'#E5E7EB', 400:'#9CA3AF' },
            ink: { 500:'#FF6600', 400:'#FF7A1A', 600:'#CC5200' }
          },
          boxShadow: {
            glow: '0 12px 28px rgba(255,102,0,0.25)',
            inset: 'inset 0 1px 0 rgba(255,255,255,0.05)',
            card: '0 1px 0 rgba(0,0,0,.35)'
          },
          backdropBlur: { xs: '2px' }
        }
      }
    }
  </script>

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --bg:#0B0B0D; --card:rgba(255,255,255,.04); --border:rgba(255,255,255,.08);
      --ink:#FF6600; --ink-soft:#FF7A1A; --text:#FFFFFF; --text-soft:#E5E7EB; --text-dim:#9CA3AF;
    }
    html,body{background:var(--bg); overflow-x:hidden;}
    body{color:var(--text-soft); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;}

    .glass{backdrop-filter:blur(8px); background:var(--card); border:1px solid var(--border)}
    .btn-ink{background:var(--ink);color:#0B0B0D;font-weight:800;letter-spacing:.02em;text-transform:uppercase}
    .btn-ink:hover{filter:brightness(1.04)}
    .btn-ghost{background:rgba(255,255,255,.04);border:1px solid var(--border)}
    .badge{display:inline-flex;align-items:center;gap:.45rem;padding:.25rem .6rem;border-radius:.5rem;background:#111114;border:1px solid var(--border)}
    .ticker{font-variant-numeric:tabular-nums;letter-spacing:.03em;font-weight:800}
    .gi-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .8rem;border-radius:0.875rem;background:linear-gradient(135deg, rgba(255,102,0,.15), rgba(255,122,26,.10));border:1px solid rgba(255,102,0,.35);box-shadow:0 0 0 1px rgba(255,102,0,.25) inset, 0 12px 28px rgba(255,102,0,.22); color:#fff;}
    .gi-badge .gi-dot{width:.6rem;height:.6rem;border-radius:9999px;background:#FF6600;box-shadow:0 0 12px rgba(255,102,0,.8)}
    .gi-badge .gi-val{font-variant-numeric:tabular-nums; font-weight:900; letter-spacing:.02em}

    /* Container: enger auf Desktop, vollbreit mobil */
    .container-max{max-width: 80rem; /* ~1088px */ width:100%;}
    .nav-wrap{padding-top:calc(var(--safe-top) + 6px);}
    .top-actions{display:flex; gap:.5rem; flex-wrap:wrap;}
    .top-actions > *{flex:1 1 140px; min-width:140px;}

    .hero-title span{display:block; line-height:1; font-weight:900;}
    .hero-title .line-orange{color:var(--ink);}
    .hero-title .line-white{color:#fff;}
    .hero-title .line-outline{color:transparent;-webkit-text-stroke:1px rgba(255,255,255,0.3)}
    .hero-title{font-size: clamp(1.6rem, 6.2vw, 3.2rem); letter-spacing: .01em;}

    table thead th{font-weight:700;color:#E5E7EB;letter-spacing:.02em;text-transform:uppercase; font-size:.75rem}
    tbody td{padding-top:.6rem; padding-bottom:.6rem;}
    tbody tr:hover td{background:rgba(255,255,255,.035)}

    .row-inline-spinner{display:inline-block;width:.9rem;height:.9rem;border-radius:9999px;border:2px solid rgba(255,255,255,.25);border-top-color:#FF6600;animation:spin 1s linear infinite;vertical-align:middle;margin-left:.4rem}
    .perk-inline-spinner{display:inline-block;width:1rem;height:1rem;border-radius:9999px;border:2px solid rgba(255,255,255,.2);border-top-color:#FF6600;animation:spin 1s linear infinite;vertical-align:middle;margin-left:.5rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    .perk-skeleton{height:2.25rem;border-radius:.75rem;background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));background-size:200% 100%;animation:sk 1.2s linear infinite;}
    @keyframes sk{0%{background-position:0% 0}100%{background-position:200% 0}}

    /* Mobile */
    @media (max-width: 640px){
      .controls-grid{display:grid; grid-template-columns: 1fr; gap: .9rem;}
      .search-row{display:grid; grid-template-columns: 1fr; gap:.6rem;}
      .search-row button{width:100%;}
      .coin-row{overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:.25rem;}
      .arrow-btn{padding:.6rem .7rem; border-radius:.7rem;}
      .top-actions{flex-direction:column;}
      .top-actions > *{min-width:0; width:100%; flex: 1 1 auto;}
      .container-max{max-width:100%;}
    }
    @media (min-width: 641px){
      .controls-grid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:1rem;}
      .search-row{display:flex; align-items:center; gap:.5rem;}
    }
  </style>
</head>

<body class="min-h-screen bg-bg-900 selection:bg-ink-500/30">
  <!-- Top bar -->
  <nav class="sticky top-0 z-40 bg-bg-900/80 backdrop-blur-xs border-b border-white/5 nav-wrap">
    <div class="container-max mx-auto px-3 sm:px-5 pb-2">
      <div class="h-10 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-6 w-6 rounded-md" style="background:linear-gradient(135deg,#1F1F22 0%, #342E2A 40%, #FF6600 100%);"></div>
          <span class="text-base font-extrabold tracking-tight text-white">SPEEDINK</span>
        </div>
      </div>
      <div class="top-actions mt-2">
        <!-- Removed: Golden Ink Holders button -->
        <a id="explorerLink" target="_blank" class="btn-ghost px-3 py-2 rounded-lg text-sm">Explorer √∂ffnen</a>
        <button id="reloadBtn" class="btn-ghost px-3 py-2 rounded-lg text-sm">Neu laden</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="relative">
    <div class="container-max mx-auto px-3 sm:px-5 py-6 md:py-10">
      <div class="flex flex-wrap gap-2 text-[10px] sm:text-xs uppercase tracking-widest">
        <span class="badge">CURRENT MAP <span id="heroMap" class="font-bold">‚Äî</span></span>
        <span class="badge">DEATH TOLL <span id="heroDeaths" class="font-bold">‚Äî</span></span>
        <span class="badge">TIME LEFT <span id="heroTime" class="ticker">‚Äî</span></span>
        <span class="badge">TOKENS <span id="heroTokens" class="font-bold">‚Äî</span></span>
      </div>
      <h1 class="hero-title mt-3 sm:mt-4">
        <span class="line-orange">STYLE IT.</span>
        <span class="line-white">SPEED IT.</span>
        <span class="line-outline">STAMP IT.</span>
      </h1>
      <p class="text-textc-200 mt-2 text-sm sm:text-base">
        NFT-basierte Zeiten ‚Ä¢ Contract <code id="contractShort" class="text-textc-400"></code>
      </p>
      <div class="mt-4 flex flex-wrap gap-2 sm:gap-3">
        <a id="createPlyrId" target="_blank" class="btn-ink px-4 py-2 rounded-xl text-sm">Create my PLYR[ID]</a>
        <a id="proofLink" target="_blank" class="btn-ghost px-4 py-2 rounded-xl text-sm">Proof</a>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="container-max mx-auto px-3 sm:px-5">
    <div class="glass rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-glow">
      <div class="controls-grid">
        <!-- Mapid -->
        <div>
          <label class="text-[13px] text-textc-200">Runde (mapid)</label>
          <div class="mt-1 flex items-center gap-2">
            <select id="mapSelect" class="w-full bg-bg-800 border border-border-900 rounded-lg sm:rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ink-500"></select>
            <button id="prevMap" title="Vorherige Runde" class="arrow-btn px-2.5 py-2 rounded-lg bg-bg-800 border border-border-900 hover:bg-[#1d1d22]">‚óÄ</button>
            <button id="nextMap" title="N√§chste Runde" class="arrow-btn px-2.5 py-2 rounded-lg bg-bg-800 border border-border-900 hover:bg-[#1d1d22]">‚ñ∂</button>
          </div>
          <p class="text-[12px] text-textc-400 mt-1">Standard: h√∂chste Runde</p>
        </div>

        <!-- Cointype Filter -->
        <div>
          <label class="text-[13px] text-textc-200">Crew / W√§hrung</label>
          <div id="coinFilter" class="coin-row mt-1 flex gap-2 overflow-x-auto pr-1 py-1"></div>
          <p class="text-[12px] text-textc-400 mt-1">Eigenes Board je W√§hrung + Gesamt-Board.</p>
        </div>

        <!-- Player search -->
        <div>
          <label class="text-[13px] text-textc-200">Spieler suchen</label>
          <div class="mt-1 search-row">
            <input id="playerSearch" placeholder="Name (ohne .plyr) oder Adresse" class="w-full bg-bg-800 border border-border-900 rounded-lg sm:rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ink-500" />
            <button id="showPlayerBtn" class="btn-ink px-4 py-2 rounded-xl text-sm">Anzeigen</button>
          </div>
          <p class="text-[12px] text-textc-400 mt-1">Tipp: Namen im Leaderboard anklicken f√ºr alle Zeiten.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Leaderboards: Zweispaltig (Desktop), gestapelt (Mobil) -->
  <main class="container-max mx-auto px-3 sm:px-5 mt-5 mb-28">
    <div class="grid gap-4 lg:gap-5 md:grid-cols-[2.2fr,0.8fr]">
      <!-- Left: Zeiten-Leaderboard -->
      <div>
        <div class="glass rounded-xl sm:rounded-2xl shadow-glow">
          <div class="flex items-center justify-between px-3 sm:px-5 py-3 border-b border-white/5">
            <div>
              <h2 class="text-lg sm:text-2xl font-extrabold text-white">Leaderboard</h2>
              <p id="boardSubtitle" class="text-textc-400 text-xs sm:text-sm"></p>
            </div>
            <div class="text-xs sm:text-sm text-textc-400"><span id="totalRows">0</span> Eintr√§ge ‚Ä¢ <span id="loadedCount">0</span> NFTs geladen</div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-left">
              <thead class="bg-[#111114]">
                <tr class="text-textc-200 text-[11px] sm:text-xs">
                  <th class="px-3 sm:px-5 py-2">Platz</th>
                  <th class="px-3 sm:px-5 py-2">Spieler</th>
                  <th class="px-3 sm:px-5 py-2">Zeit</th>
                  <th class="px-3 sm:px-5 py-2">W√§hrung</th>
                  <th class="px-3 sm:px-5 py-2">NFT</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-white/5 text-[13px] sm:text-base"></tbody>
            </table>
          </div>

          <div id="loadMoreWrap" class="flex items-center justify-center py-5 hidden">
            <button id="loadMoreBtn" class="px-5 py-2 rounded-xl bg-bg-800 border border-border-900 hover:bg-[#1d1d22]">Mehr laden‚Ä¶</button>
          </div>
        </div>
      </div>

      <!-- Right: Golden Ink Holder -->
      <aside>
        <div class="glass rounded-xl sm:rounded-2xl shadow-glow">
          <div class="flex items-center justify-between px-3 sm:px-5 py-3 border-b border-white/5">
            <div>
              <h2 class="text-lg sm:text-xl font-extrabold text-white">Golden Ink Holder</h2>
              <p class="text-textc-400 text-xs sm:text-sm">Name & Anzahl (ohne Nachkommastellen)</p>
            </div>
            <div class="text-xs sm:text-sm text-textc-400"><span id="giCount">0</span></div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-left">
              <thead class="bg-[#111114]">
                <tr class="text-textc-200 text-[11px] sm:text-xs">
                  <th class="px-3 sm:px-5 py-2">Spieler</th>
                  <th class="px-3 sm:px-5 py-2">GI</th>
                </tr>
              </thead>
              <tbody id="giHolderBody" class="divide-y divide-white/5 text-[13px] sm:text-base">
                <tr><td colspan="2" class="px-4 md:px-6 py-6 text-textc-400">Lade‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Player Modal -->
  <div id="playerModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative max-w-3xl mx-auto mt-16 glass rounded-xl sm:rounded-2xl shadow-glow">
      <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-white/5">
        <div>
          <h3 id="playerTitle" class="text-lg sm:text-xl font-extrabold text-white"></h3>
          <p id="playerSubtitle" class="text-textc-400 text-xs sm:text-sm"></p>
          <div id="giCard" class="mt-2 hidden">
            <div class="gi-badge"><span class="gi-dot"></span><span>Golden Ink</span><span class="gi-val" id="giBalanceBig">‚Äî</span></div>
          </div>
        </div>
        <button id="closePlayer" class="px-3 py-2 rounded-lg bg-bg-800 border border-border-900">Schlie√üen</button>
      </div>
      <div class="p-3 sm:p-5 max-h-[70vh] overflow-y-auto">
        <table class="min-w-full text-left">
          <thead class="bg-[#111114] text-textc-200 text-[11px] sm:text-xs">
            <tr>
              <th class="px-3 sm:px-5 py-2">Runde</th>
              <th class="px-3 sm:px-5 py-2">W√§hrung</th>
              <th class="px-3 sm:px-5 py-2">Zeit</th>
              <th class="px-3 sm:px-5 py-2">NFT</th>
            </tr>
          </thead>
          <tbody id="playerBody" class="divide-y divide-white/5 text-[13px] sm:text-base"></tbody>
        </table>

        <div class="mt-5">
          <div class="flex items-center justify-between">
            <h4 class="text-base sm:text-lg font-semibold">Perk-NFT <span id="perkSpinner" class="perk-inline-spinner hidden"></span></h4>
            <a id="perkLink" target="_blank" class="text-ink-400 hover:underline hidden">Zum NFT</a>
          </div>
          <div id="perkStatus" class="text-textc-400 text-xs sm:text-sm mt-1"></div>
          <div id="perkWrap" class="mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="fixed inset-0 pointer-events-none grid place-items-center hidden">
    <div class="p-4 rounded-2xl bg-[#111114]/90 border border-border-900 shadow-xl">
      <div class="animate-spin h-6 w-6 border-2 border-[#3f3f46] border-t-ink-500 rounded-full mx-auto"></div>
      <p class="text-sm text-textc-200 mt-2">
        <span id="loadingPhase">Suche Runden‚Ä¶</span>
        <span id="progressText" class="text-textc-400"></span>
      </p>
    </div>
  </div>

  <!-- JS: Zeiten + Modal (vollst√§ndig, funktionierend) -->
  <script>
  ;(() => {
    const API_BASE = 'https://explorer.plyr.network'
    const CONTRACT = '0x5c8b153c2451010aA074b4387Ec3573cFb547531'.toLowerCase()
    const PERK_CONTRACT = '0xa6b69deDd6c0c333CE34b2564aaCBCB7616a6dd1'.toLowerCase()
    const GI_CONTRACT = '0xEa547F310f6A9dFdB10eEAa03b76EBa8D8eCDc58'.toLowerCase()
    const ZERO = '0x0000000000000000000000000000000000000000'

    // ------------------ State ------------------
    const state = {
      items: [],          // NFTs for the SELECTED map only
      mapids: new Set(),  // All mapids discovered (from lightweight discovery pass)
      coins: new Set(),   // Coins for current map
      selectedMap: null,
      selectedCoin: 'ALL',
      baseListUrl: null,
      nextUrl: null
    }

    // ------------------ UI Refs ------------------
    const contractShort = document.getElementById('contractShort')
    const explorerLink  = document.getElementById('explorerLink')
    const mapSelect     = document.getElementById('mapSelect')
    const prevMapBtn    = document.getElementById('prevMap')
    const nextMapBtn    = document.getElementById('nextMap')
    const coinFilter    = document.getElementById('coinFilter')
    const boardSubtitle = document.getElementById('boardSubtitle')
    const tableBody     = document.getElementById('tableBody')
    const totalRows     = document.getElementById('totalRows')
    const loadedCount   = document.getElementById('loadedCount')
    const loadMoreWrap  = document.getElementById('loadMoreWrap')
    const loadMoreBtn   = document.getElementById('loadMoreBtn')
    const reloadBtn     = document.getElementById('reloadBtn')
    const loadingOverlay= document.getElementById('loadingOverlay')
    const progressText  = document.getElementById('progressText')
    const loadingPhase  = document.getElementById('loadingPhase')

    const playerModal   = document.getElementById('playerModal')
    const playerTitle   = document.getElementById('playerTitle')
    const playerSubtitle= document.getElementById('playerSubtitle')
    const playerBody    = document.getElementById('playerBody')
    const closePlayer   = document.getElementById('closePlayer')
    const playerSearch  = document.getElementById('playerSearch')
    const showPlayerBtn = document.getElementById('showPlayerBtn')
    const perkWrap      = document.getElementById('perkWrap')
    const perkStatus    = document.getElementById('perkStatus')
    const perkLink      = document.getElementById('perkLink')
    const perkSpinner   = document.getElementById('perkSpinner')

    const giCard       = document.getElementById('giCard')
    const giBalanceBig = document.getElementById('giBalanceBig')

    // Init header refs
    contractShort.textContent = CONTRACT.slice(0,8) + '‚Ä¶' + CONTRACT.slice(-6)
    explorerLink.href = `${API_BASE}/token/${CONTRACT}`

    // ------------------ Helpers ------------------
    const byKeyCI = (obj, key) => {
      if (!obj || Array.isArray(obj)) return undefined
      const found = Object.keys(obj).find(k => k.toLowerCase() === key.toLowerCase())
      return found ? obj[found] : undefined
    }
    function getAttr(meta, key) {
      if (!meta) return undefined
      if (Array.isArray(meta.attributes)) {
        const a = meta.attributes.find(x => (x.trait_type||'').toLowerCase() === key.toLowerCase())
        return a ? (a.value ?? a.display_value ?? a.trait_value) : undefined
      }
      if (typeof meta.attributes === 'object' && meta.attributes) {
        const v = byKeyCI(meta.attributes, key)
        if (v !== undefined) return v
      }
      const vTop = byKeyCI(meta, key)
      return vTop
    }
    const parseMsMaybe = (val) => {
      if (val == null) return null
      const num = Number(val)
      return Number.isNaN(num) ? null : num
    }
    const fmtMs = (ms) => {
      if (ms == null) return '‚Äî'
      const totalMs = Math.max(0, Math.round(ms))
      const m = Math.floor(totalMs / 60000)
      const s = Math.floor((totalMs % 60000) / 1000)
      const msR = totalMs % 1000
      const pad = n => String(n).padStart(2,'0')
      return `${pad(m)}:${pad(s)}.${String(msR).padStart(3,'0')}`
    }
    function cleanName(nameOrEns, address) {
      if (nameOrEns && typeof nameOrEns === 'string') {
        let n = nameOrEns
        if (n.endsWith('.plyr')) n = n.slice(0, -5)
        if (n.endsWith('.eth'))  n = n.slice(0, -4)
        return n
      }
      if (!address) return 'Unbekannt'
      return address.slice(0,6) + '‚Ä¶' + address.slice(-4)
    }
    function coinIcon(coin){
      if(coin==null) return 'ü™ô'
      const k = String(coin).trim().toUpperCase()
      const map = { BTC:'‚Çø', WBTC:'‚Çø', TBTC:'‚Çø', ETH:'‚ô¶', WETH:'‚ô¶', MATIC:'üü£', POL:'üü£', POLYGON:'üü£', LINK:'üîó', SOL:'‚óé', BNB:'üü°', AVAX:'üî∫', ADA:'üîµ', DOGE:'üêï', XRP:'‚úñ', USDT:'üü©', USDC:'üü¶', DAI:'üü®', OP:'üü•', ARB:'üü™' }
      return map[k] || 'ü™ô'
    }
    function coinBadge(coin){
      const icon = coinIcon(coin)
      const label = (coin==null || String(coin).trim()==='') ? '‚Äî' : coin
      return `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-bg-800 border border-slate-700 text-slate-200"><span>${icon}</span><span>${label}</span></span>`
    }
    function rowHtml(rank, item, bestMs) {
      const owner = item._ownerName || cleanName(item.owner?.ens_domain_name || item.owner?.name, item.owner?.hash)
      const addr  = item.owner?.hash
      const nftUrl= `${API_BASE}/token/${CONTRACT}/instance/${item.token_id || item.id}`
      return `
        <tr class="hover:bg-white/5">
          <td class="px-4 md:px-6 py-3 align-middle text-slate-300">#${rank}</td>
          <td class="px-4 md:px-6 py-3 align-middle">
            <button class="hover:underline text-slate-100 font-medium" data-player="${addr}" data-player-name="${owner}" data-player-coin="${item._coin||''}" data-player-map="${state.selectedMap}">${owner}</button>
          </td>
          <td class="px-4 md:px-6 py-3 align-middle font-mono">${fmtMs(bestMs)}</td>
          <td class="px-4 md:px-6 py-3 align-middle">${coinBadge(item._coin)}</td>
          <td class="px-4 md:px-6 py-3 align-middle"><a href="${nftUrl}" target="_blank" class="text-primary-500 hover:underline">#${item.token_id || item.id}</a></td>
        </tr>`
    }
    function setSubtitle() {
      const coinText = state.selectedCoin === 'ALL' ? 'alle W√§hrungen' : `W√§hrung ${state.selectedCoin}`
      boardSubtitle.textContent = state.selectedMap ? `Runde ${state.selectedMap} ‚Ä¢ ${coinText}` : 'Bitte zuerst eine Runde w√§hlen.'
    }
    function rebuildCoinPills() {
      coinFilter.innerHTML = ''
      const coins = ['ALL', ...Array.from(state.coins).sort((a,b)=>String(a).localeCompare(String(b)))]
      coins.forEach(c => {
        const labelHtml = c === 'ALL' ? '‚àë&nbsp;Alle' : `<span class="mr-1">${coinIcon(c)}</span>${c}`
        const btn = document.createElement('button')
        btn.className = 'px-3 py-1.5 rounded-full border text-sm whitespace-nowrap ' + (c === state.selectedCoin ? 'bg-ink-600/20 border-ink-600 text-ink-400' : 'bg-bg-800 border-slate-700 hover:border-slate-600 text-slate-200')
        btn.innerHTML = labelHtml
        btn.addEventListener('click', () => {
          state.selectedCoin = c
          renderLeaderboard()
        })
        coinFilter.appendChild(btn)
      })
    }
    function rebuildMapSelect() {
      const arr = Array.from(state.mapids).map(Number).filter(n => !Number.isNaN(n)).sort((a,b)=>b-a)
      mapSelect.innerHTML = arr.map(x => `<option value="${x}">${x}</option>`).join('')
      if (arr.length) {
        const highest = arr[0]
        state.selectedMap = highest
        mapSelect.value = highest
        document.getElementById('heroMap').textContent = highest
      }
      setSubtitle()
    }
    function computeLeaderboardFrom(items, selectedMap, selectedCoin) {
      // Return ALL runs for the selected map (and cointype filter if set), sorted by time.
      const out = []
      const mapFilter = String(selectedMap)
      for (const it of items) {
        if (String(it._map) !== mapFilter) continue
        if (selectedCoin !== 'ALL' && String(it._coin) !== String(selectedCoin)) continue
        const currentMs = parseMsMaybe(it._result)
        if (currentMs == null) continue
        out.push({ ms: currentMs, item: it })
      }
      return out.sort((a,b)=>a.ms-b.ms)
    }
    function computeLeaderboard() {
      return computeLeaderboardFrom(state.items, state.selectedMap, state.selectedCoin)
    }
    function renderLeaderboard() {

      function withRowSpinner(btn, fn){
        if (!btn) return fn()
        let sp = btn.querySelector('.row-inline-spinner')
        if (!sp){
          sp = document.createElement('span')
          sp.className = 'row-inline-spinner'
          btn.appendChild(sp)
        }
        btn.disabled = true
        const done = () => { try{ btn.disabled = false; sp.remove() }catch{} }
        const p = Promise.resolve().then(fn)
        p.finally(done)
        return p
      }

      setSubtitle()
      const rows = computeLeaderboard()
      totalRows.textContent = rows.length
      loadedCount.textContent = state.items.length
      tableBody.innerHTML = rows.map((r, i) => rowHtml(i+1, r.item, r.ms)).join('')

      // wire player buttons
      tableBody.querySelectorAll('button[data-player]').forEach(btn => {
        const coin = btn.dataset.playerCoin || null
        const map  = btn.dataset.playerMap || null
        btn.addEventListener('click', () => withRowSpinner(btn, () => openPlayer(btn.dataset.player, btn.dataset.playerName, coin, map)))
      })
    }

    // ----- Perk NFT helpers -----
    function normalizeAttributes(meta){
      const out = []
      if (!meta) return out
      const push = (label, value) => {
        const num = (value==null? null : Number(value))
        out.push({label:String(label), value, num: Number.isFinite(num) ? num : null})
      }
      if (Array.isArray(meta.attributes)){
        for (const a of meta.attributes){
          const label = a.trait_type ?? a.label ?? a.name ?? 'Trait'
          const val = a.value ?? a.display_value ?? a.trait_value ?? null
          push(label, val)
        }
      } else if (meta.attributes && typeof meta.attributes === 'object'){
        for (const [k,v] of Object.entries(meta.attributes)) push(k, v)
      }
      return out
    }
    function perkScore(meta){
      const attrs = normalizeAttributes(meta)
      const ignore = new Set(['COINTYPE','COIN','CURRENCY','MAPID','ROUND'])
      return attrs.reduce((sum,a)=> (a.num!=null && a.num>0 && !ignore.has(String(a.label).toUpperCase())) ? sum + a.num : sum, 0)
    }
    function coinForContext(items, map, selectedCoin, coinFromRow){
      if (selectedCoin && selectedCoin !== 'ALL') return selectedCoin
      if (coinFromRow) return coinFromRow
      const best = items
        .filter(it => String(it._map)===String(map) && parseMsMaybe(it._result)!=null)
        .sort((a,b)=> parseMsMaybe(a._result)-parseMsMaybe(b._result))[0]
      return best ? best._coin : null
    }
    
    // --------- Caches ---------
    const _perkCache = new Map(); // key: owner|map|coin  -> perk item or null
    const _perkOwnerIndex = new Map(); // key: owner -> array of perk items (owner-scoped fetch)
    const _erc20Decimals = new Map(); // contract -> decimals
    const _erc20BalanceCache = new Map(); // key: contract|owner -> {raw, decimals, ts}

    const cacheKey = (...parts) => parts.filter(Boolean).map(x => String(x).toLowerCase()).join('|')

    async function safeJson(url){
      try{ const r = await fetch(url); if(!r.ok) return null; return await r.json() }catch{ return null }
    }
    async function fetchPerkInstancesForOwner(owner){
      const low = (owner||'').toLowerCase()
      if (!low || low===ZERO) return []
      if (_perkOwnerIndex.has(low)) return _perkOwnerIndex.get(low)

      const candidates = [
        // Blockscout-like owner->token instances
        `${API_BASE}/api/v2/addresses/${low}/tokens/${PERK_CONTRACT}/instances?items_count=200`,
        // Generic owner NFTs list with contract filter (if supported)
        `${API_BASE}/api/v2/addresses/${low}/tokens?type=ERC-721&contract=${PERK_CONTRACT}&items_count=200`
      ]

      for (const url of candidates){
        const j = await safeJson(url)
        if (j && (Array.isArray(j.items) || Array.isArray(j.data))) {
          const list = j.items || j.data
          _perkOwnerIndex.set(low, list)
          return list
        }
      }
      _perkOwnerIndex.set(low, [])
      return []
    }

    // ERC-20 helpers (GI)
    async function getTokenDecimals(contract){
      const key = contract.toLowerCase()
      if (_erc20Decimals.has(key)) return _erc20Decimals.get(key)
      const url = `${API_BASE}/api?module=token&action=getToken&contractaddress=${contract}`
      const j = await safeJson(url)
      const d = Number(j?.result?.decimals ?? j?.decimals ?? j?.result?.tokenInfo?.decimals ?? 18)
      const decimals = Number.isFinite(d) ? d : 18
      _erc20Decimals.set(key, decimals)
      return decimals
    }

    async function getErc20Balance(contract, owner){
      const key = cacheKey(contract, owner)
      const hit = _erc20BalanceCache.get(key)
      const now = Date.now()
      if (hit && (now - hit.ts) < 60_000) return hit // 60s cache
      const url = `${API_BASE}/api?module=account&action=tokenbalance&contractaddress=${contract}&address=${owner}`
      const j = await safeJson(url)
      const raw = j?.result ?? j?.balance ?? '0'
      const decimals = await getTokenDecimals(contract)
      const entry = { raw, decimals, ts: now }
      _erc20BalanceCache.set(key, entry)
      return entry
    }

    function fmtUnits(raw, decimals){
      try{
        const bn = BigInt(String(raw))
        const d = BigInt(decimals)
        const base = BigInt(10) ** d
        const s = bn.toString()
        if (decimals === 0) return s
        const pad = s.padStart(Number(d)+1, '0')
        const i = pad.length - Number(d)
        const intPart = pad.slice(0, i)
        let frac = pad.slice(i).replace(/0+$/, '')
        return frac ? `${intPart}.${frac}` : intPart
      }catch{ return '0' }
    }

    async function findPerkInstanceForOwner(address, map, coin){
      const ckey = cacheKey(address, map ?? '', coin ?? '')
      if (_perkCache.has(ckey)) return _perkCache.get(ckey)

      const addr = (address||'').toLowerCase()
      let best = null
      let bestScore = -1

      // ---- FAST PATH: owner-scoped fetch ----
      const ownerList = await fetchPerkInstancesForOwner(addr)
      if (ownerList && ownerList.length){
        for (let it of ownerList){
          const h = (it.owner?.hash||'').toLowerCase()
          if (!h || h === ZERO || h !== addr) continue
          if (!it.metadata && it.token_id){
            const j2 = await safeJson(`${API_BASE}/api/v2/tokens/${PERK_CONTRACT}/instances/${it.token_id}`)
            if (j2 && (j2.item || j2)) it = j2.item || j2
          }
          const meta = it.metadata || {}
          const coinMeta = (getAttr(meta, 'cointype') ?? getAttr(meta,'coin') ?? getAttr(meta,'currency'))
          const mapMeta  = (getAttr(meta, 'mapid') ?? getAttr(meta,'round'))
          if (coin && String(coinMeta||'').toUpperCase() !== String(coin).toUpperCase()) continue
          if (map != null && String(mapMeta) !== String(map)) continue
          const score = perkScore(meta)
          if (score > bestScore){ bestScore = score; best = it }
        }
      }

      // ---- FALLBACK: global scan only if needed ----
      if (!best){
        const base = `${API_BASE}/api/v2/tokens/${PERK_CONTRACT}/instances`
        let nextUrl = `${base}?items_count=200`
        let guard = 0
        while (nextUrl && guard < 20){
          const j = await safeJson(nextUrl)
          if (!j) break
          const items = j.items || j.data || []
          for (let it of items){
            const h = (it.owner?.hash||'').toLowerCase()
            if (!h || h === ZERO || h !== addr) continue
            if (!it.metadata && it.token_id){
              const j2 = await safeJson(`${API_BASE}/api/v2/tokens/${PERK_CONTRACT}/instances/${it.token_id}`)
              if (j2 && (j2.item || j2)) it = j2.item || j2
            }
            const meta = it.metadata || {}
            const coinMeta = (getAttr(meta, 'cointype') ?? getAttr(meta,'coin') ?? getAttr(meta,'currency'))
            const mapMeta  = (getAttr(meta, 'mapid') ?? getAttr(meta,'round'))
            if (coin && String(coinMeta||'').toUpperCase() !== String(coin).toUpperCase()) continue
            if (map != null && String(mapMeta) !== String(map)) continue
            const score = perkScore(meta)
            if (score > bestScore){ bestScore = score; best = it }
          }
          if (best) break
          nextUrl = j.next_page_params ? (()=>{ const u=new URL(base); Object.entries(j.next_page_params).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString() })() : null
          guard++
        }
      }
      _perkCache.set(ckey, best || null)
      return best
    }

    async function loadPerkNft(address, map, coin){
      perkSpinner && perkSpinner.classList.remove('hidden')
      perkWrap.innerHTML = '<div class="perk-skeleton"></div>'
      perkStatus.textContent = 'Lade Perk-NFT‚Ä¶'
      perkLink.classList.add('hidden')
      if (!address || address.toLowerCase() === ZERO){
        perkStatus.textContent = 'Ignoriere Zero-Address.'
        perkSpinner && perkSpinner.classList.add('hidden')
        return
      }
      const item = await findPerkInstanceForOwner(address, map, coin)
      if (!item){ 
        perkStatus.textContent = `Kein Perk-NFT f√ºr Runde ${map ?? '‚Äî'}${coin? ' ‚Ä¢ '+coin:''} gefunden.`
        perkWrap.innerHTML = ''
        perkLink.classList.add('hidden')
        perkSpinner && perkSpinner.classList.add('hidden')
        return 
      }
      const id = item.token_id || item.id
      perkLink.href = `${API_BASE}/token/${PERK_CONTRACT}/instance/${id}`
      perkLink.classList.remove('hidden')
      const meta = item.metadata || {}
      const attrs = normalizeAttributes(meta).filter(x => x.num != null && x.num > 0).sort((a,b)=> b.num - a.num)
      perkStatus.textContent = `Token #${id}${map? ' ‚Ä¢ Runde '+map:''}${coin? ' ‚Ä¢ '+coin:''}`
      perkSpinner && perkSpinner.classList.add('hidden')
      perkWrap.innerHTML = attrs.length ? attrs.map(a => `
        <div class="glass rounded-xl p-3 border border-slate-700">
          <div class="text-xs text-slate-400">${a.label}</div>
          <div class="text-2xl font-bold">${a.num}</div>
        </div>`).join('') : '<div class="text-slate-400 text-sm">Keine Perks (>0) vorhanden.</div>'
    }

    async function openPlayer(address, name, coinFromRow, mapFromRow) {
      perkStatus.textContent = ''
      perkWrap.innerHTML = ''
      perkLink.classList.add('hidden')
      playerModal.classList.remove('hidden')
      giCard.classList.add('hidden'); giBalanceBig.textContent = '‚Äî'
      const list = state.items.filter(it => it.owner?.hash === address)
      const human = cleanName(name, address)
      playerTitle.textContent = human
      playerSubtitle.textContent = `${address}`
      const rows = list
        .map(it => ({ map: it._map, coin: it._coin, ms: parseMsMaybe(it._result), id: it.token_id || it.id }))
        .filter(r => r.ms != null)
        .sort((a,b)=> a.ms-b.ms)
      playerBody.innerHTML = '<tr><td colspan="4" class="px-4 md:px-6 py-3"><div class="perk-skeleton"></div></td></tr>'
      ; playerBody.innerHTML = rows.map(r => `
        <tr>
          <td class="px-4 md:px-6 py-2">${r.map}</td>
          <td class="px-4 md:px-6 py-2">${coinBadge(r.coin)}</td>
          <td class="px-4 md:px-6 py-2 font-mono">${fmtMs(r.ms)}</td>
          <td class="px-4 md:px-6 py-2"><a target="_blank" class="text-primary-500 hover:underline" href="${API_BASE}/token/${CONTRACT}/instance/${r.id}">#${r.id}</a></td>
        </tr>`).join('') || `
        <tr><td colspan="4" class="px-4 md:px-6 py-6 text-slate-400">Keine Zeiten gefunden.</td></tr>`
      const mapForPerk = mapFromRow ?? state.selectedMap
      const coinForPerk = coinForContext(list, mapForPerk, state.selectedCoin, coinFromRow)
      await loadPerkNft(address, mapForPerk, coinForPerk)

      // GI balance
      try{
        if (address && address.toLowerCase() !== ZERO){
          const bal = await getErc20Balance(GI_CONTRACT, address)
          const human = fmtUnits(bal.raw, bal.decimals)
          giBalanceBig.textContent = human
          giCard.classList.remove('hidden')
        }
      }catch{}

      playerModal.classList.remove('hidden')
    }

    closePlayer.addEventListener('click', ()=> playerModal.classList.add('hidden'))
    playerModal.addEventListener('click', (e)=> { if (e.target === playerModal) playerModal.classList.add('hidden') })
    showPlayerBtn.addEventListener('click', () => {
      const q = playerSearch.value.trim().toLowerCase()
      if (!q) return
      const hit = state.items.find(it => {
        const name = cleanName(it.owner?.ens_domain_name || it.owner?.name, it.owner?.hash).toLowerCase()
        return name === q || name.includes(q) || (it.owner?.hash||'').toLowerCase() === q
      })
      if (hit) openPlayer(hit.owner.hash, cleanName(hit.owner?.ens_domain_name || it.owner?.name, it.owner?.hash), null, state.selectedMap)
    })

    // ------------------ Load flow ------------------
    function resetUiForNewMap(){
      state.items = []
      state.coins.clear()
      totalRows.textContent = '0'
      loadedCount.textContent = '0'
      tableBody.innerHTML = ''
      coinFilter.innerHTML = ''
      state.selectedCoin = 'ALL'
      rebuildCoinPills()
    }

    async function discoverMaps(maxPages = 8, itemsPerPage = 200){
      // Lightweight pass to find available mapids and the highest mapid.
      loadingOverlay.classList.remove('hidden')
      loadingPhase.textContent = 'Suche Runden‚Ä¶ '
      progressText.textContent = ''
      state.mapids.clear()
      state.baseListUrl = `${API_BASE}/api/v2/tokens/${CONTRACT}/instances`
      let nextUrl = `${state.baseListUrl}?items_count=${itemsPerPage}`
      let pages = 0
      while (nextUrl && pages < maxPages){
        const r = await fetch(nextUrl)
        if (!r.ok) break
        const j = await r.json()
        const items = j.items || j.data || []
        for (const it of items){
          const meta = it.metadata || {}
          const mapid  = getAttr(meta, 'mapid') ?? getAttr(meta, 'round')
          if (mapid != null) state.mapids.add(Number(mapid))
        }
        // next page
        nextUrl = j.next_page_params ? (()=>{ const u=new URL(state.baseListUrl); Object.entries(j.next_page_params).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString() })() : null
        pages++
        progressText.textContent = `Seiten gescannt: ${pages}`
      }
      rebuildMapSelect()
      loadingOverlay.classList.add('hidden')
    }

    async function loadMap(mapid, scanAllPages = true, itemsPerPage = 200){
      if (!mapid) return
      resetUiForNewMap()
      loadingOverlay.classList.remove('hidden')
      loadingPhase.textContent = 'Lade Zeiten‚Ä¶ '
      progressText.textContent = ''

      const base = `${API_BASE}/api/v2/tokens/${CONTRACT}/instances`
      let nextUrl = `${base}?items_count=${itemsPerPage}`
      let pages = 0
      let countKept = 0
      while (nextUrl){
        const r = await fetch(nextUrl)
        if (!r.ok) break
        const j = await r.json()
        const items = j.items || j.data || []
        for (const it of items){
          const meta = it.metadata || {}
          const result = parseMsMaybe(getAttr(meta, 'Result'))
          const coin   = getAttr(meta, 'cointype') ?? getAttr(meta, 'coin') ?? getAttr(meta, 'currency')
          const mId    = getAttr(meta, 'mapid') ?? getAttr(meta, 'round')
          if (String(mId) !== String(mapid)) continue  // keep only selected map
          it._result = result
          it._coin   = coin ?? '‚Äî'
          it._map    = mId ?? '‚Äî'
          if (it.owner) it._ownerName = cleanName(it.owner.ens_domain_name || it.owner.name, it.owner.hash)
          state.items.push(it)
          if (coin != null && String(coin).trim() !== '') state.coins.add(String(coin))
          countKept++
        }
        // progress
        pages++
        loadedCount.textContent = state.items.length
        progressText.textContent = `Seiten: ${pages} ‚Ä¢ Treffer: ${countKept}`

        // next page
        nextUrl = j.next_page_params ? (()=>{ const u=new URL(base); Object.entries(j.next_page_params).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString() })() : null
        if (!scanAllPages && pages >= 10) break
      }

      rebuildCoinPills()
      renderLeaderboard()
      loadingOverlay.classList.add('hidden')
    }

    // Map navigation
    mapSelect.addEventListener('change', async (e) => {
      state.selectedMap = e.target.value
      await loadMap(state.selectedMap)
    })
    prevMapBtn.addEventListener('click', async ()=> {
      const arr = Array.from(state.mapids).map(Number).filter(n=>!Number.isNaN(n)).sort((a,b)=>a-b)
      const idx = arr.indexOf(Number(state.selectedMap))
      const next = arr[idx - 1]
      if (next != null) { state.selectedMap = next; mapSelect.value = next; await loadMap(next) }
    })
    nextMapBtn.addEventListener('click', async ()=> {
      const arr = Array.from(state.mapids).map(Number).filter(n=>!Number.isNaN(n)).sort((a,b)=>a-b)
      const idx = arr.indexOf(Number(state.selectedMap))
      const next = arr[idx + 1]
      if (next != null) { state.selectedMap = next; mapSelect.value = next; await loadMap(next) }
    })

    reloadBtn.addEventListener('click', async () => {
      await discoverMaps()            // re-scan rounds
      if (state.selectedMap) await loadMap(state.selectedMap) // auto-load highest
    })

    // Kickoff
    ;(async function init(){
      try {
        // Optional: token name
        try {
          const rTok = await fetch(`${API_BASE}/api?module=token&action=getToken&contractaddress=${CONTRACT}`)
          if (rTok.ok) {
            const j = await rTok.json()
            const name = j?.result?.name || 'Collection'
            const el = document.getElementById('tokenName')
            if (el) el.textContent = name
          }
        } catch {}
        await discoverMaps()       // fills mapSelect and picks highest
        if (state.selectedMap) {
          await loadMap(state.selectedMap)
        }
      } catch(e){
        console.error(e)
        alert('Fehler beim Initialisieren: ' + (e?.message || e))
      }
    })()
  })()
  </script>

  <!-- Holder-Leaderboard (vollst√§ndig) -->
  <script>
  ;(() => {
    const API_BASE = 'https://explorer.plyr.network'
    const GI = '0xEa547F310f6A9dFdB10eEAa03b76EBa8D8eCDc58'.toLowerCase()

    const giHolderBody = document.getElementById('giHolderBody')
    const giCountEl = document.getElementById('giCount')
    if (!giHolderBody) return

    async function safeJson(url){
      try{ const r = await fetch(url); if(!r.ok) return null; return await r.json() }catch{ return null }
    }
    function shorten(addr){ return addr ? addr.slice(0,6) + '‚Ä¶' + addr.slice(-4) : '‚Äî' }
    function cleanName(name){
      if (!name) return null
      let n = String(name)
      if (n.endsWith('.plyr')) n = n.slice(0, -5)
      if (n.endsWith('.eth'))  n = n.slice(0, -4)
      return n
    }
    // Ganze Zahl (ohne Nachkommastellen)
    function formatUnitsInt(raw, decimals){
      try{
        const bn = BigInt(String(raw))
        const base = BigInt(10) ** BigInt(decimals)
        return (bn / base).toString()
      }catch{ return '0' }
    }

    async function getDecimals(){
      const j = await safeJson(`${API_BASE}/api?module=token&action=getToken&contractaddress=${GI}`)
      const d = Number(j?.result?.decimals ?? 18)
      return Number.isFinite(d) ? d : 18
    }

    async function fetchHolders(limit=50){
      const out = []
      const base = `${API_BASE}/api/v2/tokens/${GI}/holders`
      let url = `${base}?items_count=200`
      let guard = 0
      while (url && out.length < limit && guard < 10){
        const j = await safeJson(url)
        if (!j) break
        const items = j.items || j.data || []
        for (const it of items){
          const addr = it.address?.hash || it.address_hash
          out.push({
            address: addr,
            raw: it.value ?? it.balance ?? '0',
            name: cleanName(it.address?.name || it.address?.ens_domain_name || null)
          })
          if (out.length >= limit) break
        }
        if (out.length >= limit) break
        url = j.next_page_params ? (()=>{ const u=new URL(base); Object.entries(j.next_page_params).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString() })() : null
        guard++
      }
      return out.filter(h=>h.address)
    }

    ;(async function initHolders(){
      try{
        const [holders, decimals] = await Promise.all([fetchHolders(50), getDecimals()])
        giCountEl.textContent = holders.length

        giHolderBody.innerHTML = holders.map(h => {
          const display = h.name || shorten(h.address)
          const giInt = formatUnitsInt(h.raw, decimals)
          return `
            <tr class="hover:bg-white/5">
              <td class="px-4 md:px-6 py-3"><span class="font-medium">${display}</span></td>
              <td class="px-4 md:px-6 py-3 font-mono">${giInt}</td>
            </tr>`
        }).join('')
      } catch(e){
        giHolderBody.innerHTML = `<tr><td colspan="2" class="px-4 md:px-6 py-6 text-red-300">Fehler beim Laden der Holder.</td></tr>`
        console.error(e)
      }
    })()
  })()
  </script>

  <!-- Glue for hero links -->
  <script>
    const createPlyrId = document.getElementById('createPlyrId');
    const proofLink = document.getElementById('proofLink');
    if (createPlyrId) createPlyrId.href = 'https://pgu.plyr.network/';
    if (proofLink) proofLink.href = 'https://explorer.plyr.network/';
  </script>
</body>
</html>
